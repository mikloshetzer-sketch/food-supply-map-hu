<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kukorica alapú ellátásbiztonsági index</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { margin:0; font-family: Arial; }
    #map { height:100vh; }

    .panel {
      position:absolute;
      top:10px; left:10px;
      background:white;
      padding:10px;
      border-radius:10px;
      z-index:9999;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.15);
    }

    .legend {
      position:absolute;
      right:10px; bottom:10px;
      background:white;
      padding:10px;
      border-radius:10px;
      font-size:12px;
      box-shadow:0 3px 10px rgba(0,0,0,.15);
    }

    .sw { width:12px; height:12px; display:inline-block; margin-right:6px; }
  </style>
</head>
<body>

<div class="panel">
  <b>Kukorica termésátlag alapú index</b><br>
  forrás: KSH XLSX
</div>

<div class="legend">
  <b>Index</b><br>
  <div><span class="sw" style="background:#f7fbff"></span>0–20</div>
  <div><span class="sw" style="background:#c6dbef"></span>40–60</div>
  <div><span class="sw" style="background:#6baed6"></span>80–100</div>
</div>

<div id="map"></div>

<script>
var map = L.map('map').setView([47.16,19.5],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function getColor(v){
  if(v<20)return"#f7fbff";
  if(v<40)return"#deebf7";
  if(v<60)return"#c6dbef";
  if(v<80)return"#9ecae1";
  return"#6baed6";
}

// 1. XLSX betöltés
fetch("data/kukoricatermesatlag.xlsx")
.then(r=>r.arrayBuffer())
.then(data=>{
  const workbook = XLSX.read(data);
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet);

  // itt később kikeressük a 2024 termésátlagot vármegyénként
  console.log(rows);

  // ideiglenes demo index generálás
  var prodIndex = {};
  rows.forEach(r=>{
    if(r.Megye){
      prodIndex[r.Megye] = Math.random()*100;
    }
  });

  return fetch("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_60M_2024_4326_LEVL_3.geojson")
  .then(r=>r.json())
  .then(fc=>({fc,prodIndex}));
})
.then(({fc,prodIndex})=>{

  var hu = {type:"FeatureCollection",features:fc.features.filter(f=>f.properties.CNTR_CODE==="HU")};

  L.geoJSON(hu,{
    style: f=>{
      var v = prodIndex[f.properties.NAME_LATN];
      return{color:"#333",weight:1,fillColor:getColor(v),fillOpacity:.6};
    },
    onEachFeature:(f,l)=>{
      var v = prodIndex[f.properties.NAME_LATN];
      l.bindPopup("<b>"+f.properties.NAME_LATN+"</b><br>Kukorica index: "+Math.round(v));
    }
  }).addTo(map);

});
</script>

</body>
</html>
