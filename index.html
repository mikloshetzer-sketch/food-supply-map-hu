<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ellátásbiztonsági index – HU</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.panel{
position:absolute; top:10px; left:10px; z-index:9999;
background:white; padding:12px; border-radius:12px;
box-shadow:0 3px 10px rgba(0,0,0,.15);
max-width:520px; font-size:13px;
}

.legend{
position:absolute; right:10px; bottom:10px;
background:white; padding:10px; border-radius:10px;
font-size:12px; box-shadow:0 3px 10px rgba(0,0,0,.12);
}

.sw{width:12px;height:12px;display:inline-block;margin-right:6px}

.row{margin-top:6px}
.ok{color:#0a7;font-weight:700}
.err{color:#b00;font-weight:700}
</style>
</head>
<body>

<div class="panel">
<b>Ellátásbiztonsági index</b><br>

<div class="row">
Mutató:
<select id="metric">
<option value="index">Index</option>
<option value="prod">Termelés (kukorica)</option>
<option value="buffer">Termelési tartalék (kukorica+búza)</option>
<option value="access">Hozzáférés (népsűrűség)</option>
</select>
</div>

<div class="row">
<b>Súlyok</b><br>
Prod <input id="wProd" type="range" min="0" max="100" value="45"><br>
Access <input id="wAccess" type="range" min="0" max="100" value="35"><br>
Buffer <input id="wBuffer" type="range" min="0" max="100" value="20">
</div>

<div class="row" id="status">Betöltés…</div>
</div>

<div class="legend">
<b>Index</b><br>
<div><span class="sw" style="background:#f7fbff"></span>0–19</div>
<div><span class="sw" style="background:#deebf7"></span>20–39</div>
<div><span class="sw" style="background:#c6dbef"></span>40–59</div>
<div><span class="sw" style="background:#9ecae1"></span>60–79</div>
<div><span class="sw" style="background:#6baed6"></span>80–100</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map('map').setView([47.1,19.5],7)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

let raw={}
let calc={}

function getColor(v){
if(v==null)return"#ddd"
if(v<20)return"#f7fbff"
if(v<40)return"#deebf7"
if(v<60)return"#c6dbef"
if(v<80)return"#9ecae1"
return"#6baed6"
}

function scale(obj){
let nums=Object.values(obj)
let min=Math.min(...nums)
let max=Math.max(...nums)
let out={}
Object.keys(obj).forEach(k=>{
out[k]=((obj[k]-min)/(max-min))*100
})
return out
}

function norm(s){
return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z]/g,"")
}

async function readExcel(file){
let ab=await fetch(file).then(r=>r.arrayBuffer())
let wb=XLSX.read(ab)
let grid=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1})
let col2024=grid[0].indexOf(2024)
let data={}
for(let i=1;i<grid.length;i++){
let name=grid[i][0]
let val=Number(grid[i][col2024])
if(name&&val)data[norm(name)]=val
}
return data
}

async function load(){

let corn=await readExcel("data/kukoricatermesatlag.xlsx")
let wheat=await readExcel("data/buzatermesatlag.xlsx")

corn=scale(corn)
wheat=scale(wheat)

let buffer={}
Object.keys(corn).forEach(k=>{
if(wheat[k]!=null)buffer[k]=(corn[k]+wheat[k])/2
})

let euro=await fetch("https://ec.europa.eu/eurostat/api/dissemination/statistics/1.0/data/DEMO_R_D3DENS?lang=EN&format=JSON&freq=A&unit=PER_KM2&lastTimePeriod=1").then(r=>r.json())
let dens={}
Object.keys(euro.value).forEach((k,i)=>{
dens[euro.dimension.geo.category.index[k]]=euro.value[i]
})
dens=scale(dens)

raw={}
Object.keys(corn).forEach(k=>{
raw[k]={prod:corn[k],buffer:buffer[k],access:dens[k]}
})

compute()

document.getElementById("status").innerHTML="<span class='ok'>OK</span> kukorica+búza+Eurostat betöltve"
}

function compute(){
let wp=document.getElementById("wProd").value/100
let wa=document.getElementById("wAccess").value/100
let wb=document.getElementById("wBuffer").value/100

calc={}
Object.keys(raw).forEach(k=>{
let r=raw[k]
calc[k]={...r,index:wp*r.prod+wa*r.access+wb*r.buffer}
})
draw()
}

function draw(){
if(window.layer)layer.remove()
fetch("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_60M_2024_4326_LEVL_3.geojson")
.then(r=>r.json())
.then(fc=>{
layer=L.geoJSON(fc,{
filter:f=>f.properties.CNTR_CODE==="HU",
style:f=>{
let id=norm(f.properties.NAME_LATN)
let v=calc[id]?calc[id][document.getElementById("metric").value]:null
return{color:"#333",weight:1,fillColor:getColor(v),fillOpacity:.6}
},
onEachFeature:(f,l)=>{
let id=norm(f.properties.NAME_LATN)
let d=calc[id]
l.bindPopup(f.properties.NAME_LATN+"<br>Index:"+Math.round(d.index))
}
}).addTo(map)
})
}

document.getElementById("metric").onchange=draw
document.getElementById("wProd").oninput=compute
document.getElementById("wAccess").oninput=compute
document.getElementById("wBuffer").oninput=compute

load()
</script>

</body>
</html>
