<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Élelmiszer-ellátásbiztonság – Szenáriók</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    .panel {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.94);
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      max-width: 360px;
      font-size: 13px;
      line-height: 1.3;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    }

    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top: 6px; }
    select { padding: 3px 5px; font-size: 13px; }

    .btn {
      padding: 4px 8px;
      border: 1px solid #333;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }
    .btn.active { background: #333; color: #fff; }

    .sliders { margin-top: 6px; }
    .srow { display:flex; align-items:center; gap:6px; margin-top: 4px; }
    .srow label { width: 55px; font-weight: 700; font-size: 12px; }
    .srow input[type="range"] { width: 150px; }
    .val { width: 36px; text-align: right; font-size: 12px; }

    .legend {
      position: absolute;
      right: 10px; bottom: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 12px;
    }
    .legend .item { display:flex; align-items:center; gap:6px; margin-top:4px; }
    .sw { width: 12px; height: 12px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }

    .small { font-size: 11px; color:#444; }
  </style>
</head>
<body>

<div class="panel">
  <b>Ellátásbiztonsági index</b>

  <div class="row">
    <label><b>Mutató:</b></label>
    <select id="metric">
      <option value="index">Index</option>
      <option value="prod">Termelés</option>
      <option value="access">Hozzáférés</option>
      <option value="buffer">Tartalék</option>
    </select>
  </div>

  <div class="row">
    <button class="btn active" id="btnNormal">Normál</button>
    <button class="btn" id="btnDrought">Aszály</button>
    <button class="btn" id="btnLogistics">Logisztika</button>
  </div>

  <div class="sliders">
    <div class="srow">
      <label>Prod</label>
      <input id="wProd" type="range" min="0" max="100" value="45" />
      <div class="val"><span id="wProdVal">0.45</span></div>
    </div>

    <div class="srow">
      <label>Access</label>
      <input id="wAccess" type="range" min="0" max="100" value="35" />
      <div class="val"><span id="wAccessVal">0.35</span></div>
    </div>

    <div class="srow">
      <label>Buffer</label>
      <input id="wBuffer" type="range" min="0" max="100" value="20" />
      <div class="val"><span id="wBufferVal">0.20</span></div>
    </div>
  </div>

  <div class="small">Kattints vármegyére</div>
</div>

<div class="legend">
  <b>Jelmagyarázat</b>
  <div id="legendItems"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  var map = L.map('map').setView([47.16, 19.5], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  var metricSelect = document.getElementById("metric");
  var wProdEl = document.getElementById("wProd");
  var wAccessEl = document.getElementById("wAccess");
  var wBufferEl = document.getElementById("wBuffer");

  var wProdVal = document.getElementById("wProdVal");
  var wAccessVal = document.getElementById("wAccessVal");
  var wBufferVal = document.getElementById("wBufferVal");

  var btnNormal = document.getElementById("btnNormal");
  var btnDrought = document.getElementById("btnDrought");
  var btnLogistics = document.getElementById("btnLogistics");

  var nutsLayer = null;
  var selectedLayer = null;

  var rawByNutsId = {};
  var indexByNutsId = {};

  function round1(x){ return Math.round(x*10)/10; }

  function parseCSV(text){
    var lines=text.trim().split(/\r?\n/);
    var header=lines[0].split(",");
    var out=[];
    for(var i=1;i<lines.length;i++){
      var cols=lines[i].split(",");
      var r={};
      for(var j=0;j<header.length;j++) r[header[j]]=cols[j];
      out.push(r);
    }
    return out;
  }

  function getColor(v){
    if(v<20)return"#f7fbff";
    if(v<40)return"#deebf7";
    if(v<60)return"#c6dbef";
    if(v<80)return"#9ecae1";
    return"#6baed6";
  }

  function computeIndex(){
    var wp=wProdEl.value/100;
    var wa=wAccessEl.value/100;
    var wb=wBufferEl.value/100;
    var s=wp+wa+wb;
    wp/=s; wa/=s; wb/=s;

    indexByNutsId={};
    Object.keys(rawByNutsId).forEach(id=>{
      var r=rawByNutsId[id];
      var idx=round1(wp*r.prod+wa*r.access+wb*r.buffer);
      indexByNutsId[id]={...r,index:idx};
    });
  }

  function baseStyle(feature){
    var id=feature.properties.NUTS_ID;
    var v=indexByNutsId[id]?.[metricSelect.value];
    return{color:"#333",weight:1,fillColor:getColor(v),fillOpacity:.6};
  }

  function refresh(){ nutsLayer.setStyle(baseStyle); }

  function applyScenario(n){
    if(n==="normal"){wProdEl.value=45;wAccessEl.value=35;wBufferEl.value=20;}
    if(n==="drought"){wProdEl.value=55;wAccessEl.value=25;wBufferEl.value=20;}
    if(n==="logistics"){wProdEl.value=35;wAccessEl.value=50;wBufferEl.value=15;}
    computeIndex();refresh();
  }

  metricSelect.onchange=refresh;
  [wProdEl,wAccessEl,wBufferEl].forEach(el=>el.oninput=()=>{computeIndex();refresh();});

  btnNormal.onclick=()=>applyScenario("normal");
  btnDrought.onclick=()=>applyScenario("drought");
  btnLogistics.onclick=()=>applyScenario("logistics");

  fetch("data/food_index.csv")
  .then(r=>r.text())
  .then(t=>{
    parseCSV(t).forEach(r=>{
      rawByNutsId[r.NUTS_ID]={prod:+r.prod,access:+r.access,buffer:+r.buffer};
    });
    computeIndex();
    return fetch("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_60M_2024_4326_LEVL_3.geojson");
  })
  .then(r=>r.json())
  .then(fc=>{
    var hu={type:"FeatureCollection",features:fc.features.filter(f=>f.properties.CNTR_CODE==="HU")};
    nutsLayer=L.geoJSON(hu,{style:baseStyle,onEachFeature:(f,l)=>{
      l.on("click",()=>{
        var d=indexByNutsId[f.properties.NUTS_ID];
        l.bindPopup("<b>"+f.properties.NAME_LATN+"</b><br>Index:"+d.index).openPopup();
      });
    }}).addTo(map);
    map.fitBounds(nutsLayer.getBounds());
  });
</script>

</body>
</html>
