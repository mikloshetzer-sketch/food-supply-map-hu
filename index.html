<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Supply Index – Szenáriók</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    .panel {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.98);
      padding: 12px 14px;
      border: 2px solid #111;
      border-radius: 14px;
      max-width: 620px;
      font-size: 14px;
      line-height: 1.35;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .version {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #111;
      font-size: 12px;
      margin-left: 8px;
    }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 10px; }
    select { padding: 6px 8px; font-size: 14px; }

    .btn {
      padding: 10px 14px;
      border: 2px solid #111;
      background: #fff;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      font-size: 15px;
    }
    .btn.active { background: #111; color: #fff; }

    .sliders { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px; }
    .srow { display:flex; align-items:center; gap:10px; margin-top: 8px; }
    .srow label { width: 80px; font-weight: 800; }
    .srow input[type="range"] { width: 260px; }
    .val { width: 54px; text-align: right; font-variant-numeric: tabular-nums; font-weight: 800; }

    .legend {
      position: absolute;
      right: 10px; bottom: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.96);
      padding: 10px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.25;
      min-width: 190px;
    }
    .legend .item { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .sw { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.15); }

    .ok { color:#0a7; font-weight:900; }
    .err { color:#b00; font-weight:900; }
    .small { font-size: 12px; color:#333; }
    code { font-size: 12px; }
  </style>
</head>
<body>

<div class="panel">
  <div>
    <b>Élelmiszer-ellátásbiztonsági index</b>
    <span class="version">VERZIÓ: SCENARIO-TEST-1</span>
  </div>
  <div class="small">
    Ha ezt a <b>VERZIÓ</b> feliratot látod, akkor biztosan az új index.html fut.
  </div>

  <div class="row">
    <label for="metric"><b>Mutató:</b></label>
    <select id="metric">
      <option value="index">Összesített index</option>
      <option value="prod">Termelési komponens</option>
      <option value="access">Hozzáférés komponens</option>
      <option value="buffer">Tartalék/robosztusság komponens</option>
    </select>
    <span>Állapot: <span id="status">betöltés…</span></span>
  </div>

  <div class="row">
    <b>SZENÁRIÓ GOMBOK (ITT KELL LÁTSZÓDNIUK):</b><br/>
    <button class="btn active" id="btnNormal">Normál</button>
    <button class="btn" id="btnDrought">Aszály</button>
    <button class="btn" id="btnLogistics">Logisztika</button>
  </div>

  <div class="sliders">
    <div class="small">Index: <code>wP·prod + wA·access + wB·buffer</code> (normalizálás 1-re)</div>

    <div class="srow">
      <label>Prod</label>
      <input id="wProd" type="range" min="0" max="100" value="45" />
      <div class="val"><span id="wProdVal">0.45</span></div>
    </div>

    <div class="srow">
      <label>Access</label>
      <input id="wAccess" type="range" min="0" max="100" value="35" />
      <div class="val"><span id="wAccessVal">0.35</span></div>
    </div>

    <div class="srow">
      <label>Buffer</label>
      <input id="wBuffer" type="range" min="0" max="100" value="20" />
      <div class="val"><span id="wBufferVal">0.20</span></div>
    </div>

    <div class="small" id="sumInfo"></div>
  </div>

  <div class="small" style="margin-top:8px;">Kattints egy vármegyére: popup.</div>
</div>

<div class="legend">
  <b>Jelmagyarázat</b>
  <div id="legendItems"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  console.log("SCENARIO-TEST-1 loaded");

  var map = L.map('map').setView([47.16, 19.5], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  var metricSelect = document.getElementById("metric");
  var statusEl = document.getElementById("status");

  var wProdEl = document.getElementById("wProd");
  var wAccessEl = document.getElementById("wAccess");
  var wBufferEl = document.getElementById("wBuffer");
  var wProdVal = document.getElementById("wProdVal");
  var wAccessVal = document.getElementById("wAccessVal");
  var wBufferVal = document.getElementById("wBufferVal");
  var sumInfo = document.getElementById("sumInfo");

  var btnNormal = document.getElementById("btnNormal");
  var btnDrought = document.getElementById("btnDrought");
  var btnLogistics = document.getElementById("btnLogistics");

  var nutsLayer = null;
  var selectedLayer = null;

  var rawByNutsId = {};
  var indexByNutsId = {};

  function round1(x) { return (x==null || isNaN(x)) ? null : Math.round(x*10)/10; }

  function parseCSV(text) {
    var lines = text.trim().split(/\r?\n/);
    var header = lines[0].split(",").map(s => s.trim());
    var out = [];
    for (var i=1; i<lines.length; i++) {
      if (!lines[i].trim()) continue;
      var cols = lines[i].split(",").map(s => s.trim());
      var row = {};
      for (var j=0; j<header.length; j++) row[header[j]] = cols[j];
      out.push(row);
    }
    return out;
  }

  function getColor(v) {
    if (v == null || isNaN(v)) return "#dddddd";
    if (v < 20) return "#f7fbff";
    if (v < 40) return "#deebf7";
    if (v < 60) return "#c6dbef";
    if (v < 80) return "#9ecae1";
    return "#6baed6";
  }

  function updateLegend() {
    var items = document.getElementById("legendItems");
    var labels = [
      {t:"0–19", c:getColor(0)},
      {t:"20–39", c:getColor(20)},
      {t:"40–59", c:getColor(40)},
      {t:"60–79", c:getColor(60)},
      {t:"80–100", c:getColor(80)},
      {t:"nincs adat", c:"#dddddd"}
    ];
    items.innerHTML = "";
    labels.forEach(function(x) {
      var div = document.createElement("div");
      div.className = "item";
      var sw = document.createElement("span");
      sw.className = "sw";
      sw.style.background = x.c;
      var tx = document.createElement("span");
      tx.textContent = x.t;
      div.appendChild(sw);
      div.appendChild(tx);
      items.appendChild(div);
    });
  }

  function getName(props) { return props.NAME_LATN || props.NUTS_NAME || "Terület"; }
  function getNutsId(props) { return props.NUTS_ID || ""; }

  function readWeights() {
    return {
      wp: Number(wProdEl.value) / 100,
      wa: Number(wAccessEl.value) / 100,
      wb: Number(wBufferEl.value) / 100
    };
  }

  function normalizeWeights(w) {
    var s = w.wp + w.wa + w.wb;
    if (s <= 0) return { wp: 0.45, wa: 0.35, wb: 0.20, rawSum: 1 };
    return { wp: w.wp / s, wa: w.wa / s, wb: w.wb / s, rawSum: s };
  }

  function updateWeightUI() {
    var w = readWeights();
    var s = w.wp + w.wa + w.wb;
    wProdVal.textContent = w.wp.toFixed(2);
    wAccessVal.textContent = w.wa.toFixed(2);
    wBufferVal.textContent = w.wb.toFixed(2);
    sumInfo.textContent = (Math.abs(s-1) < 0.001)
      ? "Súlyösszeg = 1.00"
      : ("Súlyösszeg = " + s.toFixed(2) + " → normalizálom 1-re");
  }

  function computeIndexForAll() {
    var w = normalizeWeights(readWeights());
    indexByNutsId = {};
    Object.keys(rawByNutsId).forEach(function(id) {
      var r = rawByNutsId[id];
      var prod = Number(r.prod);
      var access = Number(r.access);
      var buffer = Number(r.buffer);
      var idx = round1(w.wp * prod + w.wa * access + w.wb * buffer);
      indexByNutsId[id] = { prod: round1(prod), access: round1(access), buffer: round1(buffer), index: idx };
    });
  }

  function baseStyle(feature) {
    var p = feature.properties || {};
    var id = getNutsId(p);
    var metric = metricSelect.value;
    var rec = indexByNutsId[id];
    var v = rec ? Number(rec[metric]) : null;
    return { color: "#333", weight: 1, fillColor: getColor(v), fillOpacity: 0.6 };
  }
  function hoverStyle() { return { weight: 3, color: "#111", fillOpacity: 0.8 }; }
  function selectedStyle() { return { weight: 4, color: "#000", fillOpacity: 0.9 }; }

  function onEachFeature(feature, layer) {
    var p = feature.properties || {};
    var name = getName(p);
    var id = getNutsId(p);

    layer.on("mouseover", function(e) { e.target.setStyle(hoverStyle()); e.target.bringToFront(); });
    layer.on("mouseout", function(e) { if (selectedLayer !== e.target && nutsLayer) nutsLayer.resetStyle(e.target); });

    layer.on("click", function(e) {
      if (selectedLayer && selectedLayer !== e.target && nutsLayer) nutsLayer.resetStyle(selectedLayer);
      selectedLayer = e.target;
      e.target.setStyle(selectedStyle());
      e.target.bringToFront();

      var rec = indexByNutsId[id] || {};
      layer.bindPopup(
        "<b>" + name + "</b><br/><span style='font-size:12px;color:#555'>NUTS_ID: " + id + "</span>" +
        "<hr style='border:none;border-top:1px solid #eee;margin:8px 0'/>" +
        "<b>Index:</b> " + (rec.index ?? "n/a") + "<br/>" +
        "<b>Prod:</b> " + (rec.prod ?? "n/a") + "<br/>" +
        "<b>Access:</b> " + (rec.access ?? "n/a") + "<br/>" +
        "<b>Buffer:</b> " + (rec.buffer ?? "n/a")
      ).openPopup();
    });
  }

  function renderLayer(huGeojson) {
    if (nutsLayer) nutsLayer.remove();
    nutsLayer = L.geoJSON(huGeojson, { style: baseStyle, onEachFeature: onEachFeature }).addTo(map);
    try { map.fitBounds(nutsLayer.getBounds(), { padding: [20,20] }); } catch(e) {}
  }

  function refreshStyles() {
    if (!nutsLayer) return;
    nutsLayer.setStyle(baseStyle);
    updateLegend();
    if (selectedLayer) selectedLayer.setStyle(selectedStyle());
  }

  function recalcAndRefresh() {
    updateWeightUI();
    computeIndexForAll();
    refreshStyles();
  }

  function setActive(btn) {
    [btnNormal, btnDrought, btnLogistics].forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  function applyScenario(which) {
    if (which === "normal") { wProdEl.value = 45; wAccessEl.value = 35; wBufferEl.value = 20; setActive(btnNormal); }
    if (which === "drought") { wProdEl.value = 55; wAccessEl.value = 25; wBufferEl.value = 20; setActive(btnDrought); }
    if (which === "logistics") { wProdEl.value = 35; wAccessEl.value = 50; wBufferEl.value = 15; setActive(btnLogistics); }
    recalcAndRefresh();
  }

  metricSelect.addEventListener("change", refreshStyles);
  [wProdEl, wAccessEl, wBufferEl].forEach(el => el.addEventListener("input", function() {
    [btnNormal, btnDrought, btnLogistics].forEach(b => b.classList.remove("active"));
    recalcAndRefresh();
  }));

  btnNormal.addEventListener("click", () => applyScenario("normal"));
  btnDrought.addEventListener("click", () => applyScenario("drought"));
  btnLogistics.addEventListener("click", () => applyScenario("logistics"));

  updateLegend();
  updateWeightUI();

  fetch("data/food_index.csv")
    .then(r => { if (!r.ok) throw new Error("CSV HTTP " + r.status); return r.text(); })
    .then(text => {
      var rows = parseCSV(text);
      rows.forEach(function(r) {
        rawByNutsId[r.NUTS_ID] = { prod: Number(r.prod), access: Number(r.access), buffer: Number(r.buffer) };
      });
      computeIndexForAll();

      var url = "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_60M_2024_4326_LEVL_3.geojson";
      return fetch(url);
    })
    .then(r => { if (!r.ok) throw new Error("GISCO HTTP " + r.status); return r.json(); })
    .then(fc => {
      var hu = {
        type: "FeatureCollection",
        features: (fc.features || []).filter(function(f) {
          var p = f.properties || {};
          var id = (p.NUTS_ID || "");
          var cc = (p.CNTR_CODE || "");
          return cc === "HU" || (typeof id === "string" && id.startsWith("HU"));
        })
      };
      renderLayer(hu);
      statusEl.innerHTML = "<span class='ok'>OK</span> – gomboknak látszódniuk kell";
    })
    .catch(err => {
      console.error(err);
      statusEl.innerHTML = "<span class='err'>HIBA</span> " + err.message;
      alert("Hiba: " + err.message);
    });
</script>

</body>
</html>
